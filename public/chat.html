<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© - Olk Dev</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Sidebar -->
        <aside class="chat-sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/" class="logo">
                    <div class="logo-icon">ğŸ¤–</div>
                    <span>Olk Dev</span>
                </a>
            </div>

            <button class="btn btn-primary" id="newChatBtn" style="margin: 12px; width: calc(100% - 24px);">
                <span>â•</span>
                Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
            </button>

            <div class="chat-list" id="chatList">
                <!-- Chats will be loaded here -->
            </div>

            <div style="padding: 16px; border-top: 1px solid var(--border-color);">
                <div class="user-info" id="userInfo">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div class="user-name" id="userName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
                        <div class="user-email" id="userEmail">user@email.com</div>
                    </div>
                </div>
                <button class="btn btn-ghost btn-sm" id="logoutBtn" style="width: 100%; margin-top: 12px;">
                    <span>ğŸšª</span>
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <header class="chat-header">
                <button class="btn btn-ghost" id="menuBtn" style="display: none;">â˜°</button>
                <h2 id="chatTitle">Olk Dev AI</h2>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-ghost btn-sm" id="deleteChatBtn" style="display: none;">
                        <span>ğŸ—‘ï¸</span>
                    </button>
                </div>
            </header>

            <!-- Messages Area -->
            <div class="chat-messages" id="messagesArea">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">ğŸ¤–</div>
                    <h2 class="welcome-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Olk Dev!</h2>
                    <p class="welcome-description">
                        Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©ØŒ Ø£Ø±Ø³Ù„ Ù„ÙŠ ÙƒÙˆØ¯Ùƒ Ù„ØªØ­Ù„ÙŠÙ„Ù‡ØŒ Ø£Ùˆ Ø§Ø·Ù„Ø¨
                        Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø­Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.
                    </p>
                    <div class="suggestions">
                        <button class="suggestion-chip" onclick="sendSuggestion('ÙƒÙŠÙ Ø£Ø¨Ø¯Ø£ ØªØ¹Ù„Ù… JavaScriptØŸ')">
                            ğŸ”° ÙƒÙŠÙ Ø£Ø¨Ø¯Ø£ ØªØ¹Ù„Ù… JavaScriptØŸ
                        </button>
                        <button class="suggestion-chip" onclick="sendSuggestion('Ø§Ø´Ø±Ø­ Ù„ÙŠ Ù…Ø§ Ù‡Ùˆ API')">
                            ğŸ“š Ø§Ø´Ø±Ø­ Ù„ÙŠ Ù…Ø§ Ù‡Ùˆ API
                        </button>
                        <button class="suggestion-chip" onclick="sendSuggestion('Ø³Ø§Ø¹Ø¯Ù†ÙŠ ÙÙŠ ØªØµØ­ÙŠØ­ Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£')">
                            ğŸ› Ø³Ø§Ø¹Ø¯Ù†ÙŠ ÙÙŠ ØªØµØ­ÙŠØ­ Ø®Ø·Ø£
                        </button>
                        <button class="suggestion-chip" onclick="sendSuggestion('ÙƒÙŠÙ Ø£Ø­Ø³Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ØŸ')">
                            âš¡ ÙƒÙŠÙ Ø£Ø­Ø³Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ØŸ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea id="messageInput" class="chat-input"
                        placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§... (ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©)" rows="1"></textarea>
                    <button class="chat-send-btn" id="sendBtn" disabled>
                        â¤
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API_URL = '';
        let currentChatId = null;
        let chats = [];

        // Get token and user
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // Check authentication
        if (!token) {
            window.location.href = '/login';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            loadChats();
        });

        function initializeUI() {
            // Set user info
            document.getElementById('userName').textContent = user.username || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
            document.getElementById('userEmail').textContent = user.email || '';
            document.getElementById('userAvatar').textContent = (user.username || 'U')[0].toUpperCase();

            // Event listeners
            document.getElementById('newChatBtn').addEventListener('click', createNewChat);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('deleteChatBtn').addEventListener('click', deleteCurrentChat);

            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', handleInput);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Mobile menu
            document.getElementById('menuBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('open');
            });
        }

        function handleInput() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            // Auto-resize
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 150) + 'px';

            // Enable/disable send button
            sendBtn.disabled = !input.value.trim();
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // API helper
        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });

            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login';
                return null;
            }

            return response;
        }

        // Load chats
        async function loadChats() {
            try {
                const response = await apiCall('/api/chats');
                const data = await response.json();
                chats = data.chats || [];
                renderChatList();
            } catch (error) {
                console.error('Failed to load chats:', error);
            }
        }

        // Render chat list
        function renderChatList() {
            const chatList = document.getElementById('chatList');

            if (chats.length === 0) {
                chatList.innerHTML = `
          <div class="empty-state" style="padding: 32px 16px;">
            <div style="font-size: 2rem; margin-bottom: 8px;">ğŸ’¬</div>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª</p>
          </div>
        `;
                return;
            }

            chatList.innerHTML = chats.map(chat => `
        <div class="chat-item ${chat._id === currentChatId ? 'active' : ''}" 
             onclick="openChat('${chat._id}')" data-id="${chat._id}">
          <span class="chat-item-icon">ğŸ’¬</span>
          <span class="chat-item-title">${escapeHtml(chat.title)}</span>
        </div>
      `).join('');
        }

        // Create new chat
        async function createNewChat() {
            try {
                const response = await apiCall('/api/chats', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    chats.unshift(data.chat);
                    currentChatId = data.chat._id;
                    renderChatList();
                    showMessages([]);
                    document.getElementById('deleteChatBtn').style.display = 'flex';
                    showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©', 'success');
                }
            } catch (error) {
                showToast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'error');
            }
        }

        // Open chat
        async function openChat(chatId) {
            currentChatId = chatId;
            renderChatList();

            try {
                const response = await apiCall(`/api/chats/${chatId}`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('chatTitle').textContent = data.chat.title;
                    showMessages(data.chat.messages);
                    document.getElementById('deleteChatBtn').style.display = 'flex';
                }
            } catch (error) {
                showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'error');
            }

            // Close sidebar on mobile
            document.getElementById('sidebar').classList.remove('open');
        }

        // Show messages
        function showMessages(messages) {
            const messagesArea = document.getElementById('messagesArea');
            const welcomeScreen = document.getElementById('welcomeScreen');

            if (messages.length === 0) {
                welcomeScreen.style.display = 'flex';
                messagesArea.innerHTML = '';
                messagesArea.appendChild(welcomeScreen);
                return;
            }

            welcomeScreen.style.display = 'none';
            messagesArea.innerHTML = messages.map(msg => createMessageHTML(msg)).join('');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Create message HTML
        function createMessageHTML(message) {
            const isUser = message.role === 'user';
            const content = formatMessageContent(message.content);

            return `
        <div class="message ${isUser ? 'user' : 'assistant'}">
          <div class="message-avatar">${isUser ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
          <div class="message-content">${content}</div>
        </div>
      `;
        }

        // Format message content with markdown
        function formatMessageContent(content) {
            // Escape HTML first
            let formatted = escapeHtml(content);

            // Code blocks
            formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code class="language-${lang || ''}">${code.trim()}</code></pre>`;
            });

            // Inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Bold
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // Lists
            formatted = formatted.replace(/^- (.+)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

            // Numbered lists
            formatted = formatted.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

            // Line breaks
            formatted = formatted.replace(/\n/g, '<br>');

            return formatted;
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) return;

            // Create new chat if none selected
            if (!currentChatId) {
                await createNewChat();
                if (!currentChatId) return;
            }

            // Clear input
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('sendBtn').disabled = true;

            // Hide welcome screen and add user message
            document.getElementById('welcomeScreen').style.display = 'none';
            const messagesArea = document.getElementById('messagesArea');

            // Add user message
            messagesArea.innerHTML += createMessageHTML({ role: 'user', content });

            // Add typing indicator
            const typingId = 'typing-' + Date.now();
            messagesArea.innerHTML += `
        <div class="message assistant" id="${typingId}">
          <div class="message-avatar">ğŸ¤–</div>
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;
            messagesArea.scrollTop = messagesArea.scrollHeight;

            try {
                const response = await apiCall(`/api/chats/${currentChatId}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                // Remove typing indicator
                document.getElementById(typingId)?.remove();

                if (response.ok) {
                    // Add assistant message
                    messagesArea.innerHTML += createMessageHTML(data.assistantMessage);
                    messagesArea.scrollTop = messagesArea.scrollHeight;

                    // Update chat title in list
                    const chatIndex = chats.findIndex(c => c._id === currentChatId);
                    if (chatIndex !== -1) {
                        chats[chatIndex].title = data.chat.title;
                        document.getElementById('chatTitle').textContent = data.chat.title;
                        renderChatList();
                    }
                } else {
                    showToast(data.message || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
                }
            } catch (error) {
                document.getElementById(typingId)?.remove();
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            }
        }

        // Send suggestion
        function sendSuggestion(text) {
            document.getElementById('messageInput').value = text;
            handleInput();
            sendMessage();
        }

        // Delete current chat
        async function deleteCurrentChat() {
            if (!currentChatId) return;

            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ')) return;

            try {
                const response = await apiCall(`/api/chats/${currentChatId}`, { method: 'DELETE' });

                if (response.ok) {
                    chats = chats.filter(c => c._id !== currentChatId);
                    currentChatId = null;
                    renderChatList();
                    showMessages([]);
                    document.getElementById('chatTitle').textContent = 'Olk Dev AI';
                    document.getElementById('deleteChatBtn').style.display = 'none';
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'success');
                }
            } catch (error) {
                showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'error');
            }
        }

        // Logout
        async function logout() {
            try {
                await apiCall('/api/auth/logout', { method: 'POST' });
            } catch (e) { }

            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>